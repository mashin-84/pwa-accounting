<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA è¨˜å¸³ç³»çµ±</title>
    <link rel="manifest" href="manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('serviceWorker.js');
        }
    </script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
        input, select, button { margin: 10px; padding: 10px; width: 90%; max-width: 400px; }
        #recordList { margin-top: 20px; }
    </style>
</head>
<body>
    <h2>è¨˜å¸³è¼¸å…¥</h2>
    <input type="date" id="date" required>
    <select id="account"></select>
    <select id="type" onchange="updateCategoryList()">
        <option value="æ”¯å‡º">æ”¯å‡º</option>
        <option value="æ”¶å…¥">æ”¶å…¥</option>
    </select>
    <select id="category"></select>
    <input type="number" id="amount" placeholder="é‡‘é¡" required>
    <input type="text" id="description" placeholder="èŠ±è²»å…§å®¹">
    <button onclick="saveRecord()">å„²å­˜</button>
    
    <h3>æ•¸æ“šåŒæ­¥</h3>
    <button onclick="confirmUpload()">ğŸ“¤ ä¸Šå‚³è³‡æ–™</button>
    <button onclick="confirmDownload()">ğŸ“¥ ä¸‹è¼‰è³‡æ–™</button>
    
    <h3>è¨˜å¸³æ¸…å–®</h3>
    <button onclick="showRecords()">ğŸ“‹ æŸ¥çœ‹è¨˜å¸³æ¸…å–®</button>
    <div id="recordList"></div>

    <script>
        let apiUrl = "https://script.google.com/macros/s/AKfycby4dt5yEttAXVUmJgGHrjpfVS9Eie-0NImQDqdqEB8tBQSkaOA8wCNcU4bjBUwcPvP7/exec";
        let records = JSON.parse(localStorage.getItem("records")) || [];
        let categories = { accounts: [], income: [], expense: [] };

        function fetchCategoriesFromSheet() {
            fetch(apiUrl + "?action=getCategories")
            .then(response => response.json())
            .then(data => {
                if (data["å¸³æˆ¶æ¸…å–®"] && data["æ”¶å…¥é¡åˆ¥æ¸…å–®"] && data["æ”¯å‡ºé¡åˆ¥æ¸…å–®"]) {
                    categories.accounts = data["å¸³æˆ¶æ¸…å–®"];
                    categories.income = data["æ”¶å…¥é¡åˆ¥æ¸…å–®"];
                    categories.expense = data["æ”¯å‡ºé¡åˆ¥æ¸…å–®"];
                    localStorage.setItem("categories", JSON.stringify(categories));
                    populateAccounts();
                    updateCategoryList();
                } else {
                    console.error("ç„¡æ³•ç²å–æ­£ç¢ºçš„é¡åˆ¥æ•¸æ“š: ", data);
                }
            })
            .catch(error => console.error("å¾è©¦ç®—è¡¨ç²å–é¡åˆ¥å¤±æ•—: ", error));
        }
        
        function updateCategoryList() {
            let type = document.getElementById("type").value;
            let categorySelect = document.getElementById("category");
            categorySelect.innerHTML = "";
            let selectedCategories = type === "æ”¶å…¥" ? categories.income : categories.expense;
            selectedCategories.forEach(cat => {
                let option = document.createElement("option");
                option.value = cat;
                option.textContent = cat;
                categorySelect.appendChild(option);
            });
        }
        
        function populateAccounts() {
            let accountSelect = document.getElementById("account");
            accountSelect.innerHTML = "";
            categories.accounts.forEach(account => {
                let option = document.createElement("option");
                option.value = account;
                option.textContent = account;
                accountSelect.appendChild(option);
            });
        }
        
        function initializeForm() {
            fetchCategoriesFromSheet();
        }

        function saveRecord() {
            let record = {
                date: document.getElementById("date").value,
                account: document.getElementById("account").value,
                category: document.getElementById("category").value,
                amount: document.getElementById("amount").value,
                description: document.getElementById("description").value,
                type: document.getElementById("type").value
            };
            records.push(record);
            localStorage.setItem("records", JSON.stringify(records));
            alert("è¨˜éŒ„å·²å„²å­˜ï¼");
        }

        function confirmUpload() {
            if (confirm("ç¢ºå®šè¦ä¸Šå‚³è³‡æ–™å—ï¼Ÿé€™å°‡åŒæ­¥æ‰‹æ©Ÿä¸Šçš„è¨˜å¸³è³‡æ–™è‡³ Google è©¦ç®—è¡¨ï¼Œä¸¦åˆªé™¤å·²åˆªé™¤çš„é …ç›®ã€‚")) {
                uploadData();
            }
        }

        function confirmDownload() {
            if (confirm("ç¢ºå®šè¦ä¸‹è¼‰è³‡æ–™å—ï¼Ÿé€™å°‡æ¸…é™¤æ‰‹æ©Ÿä¸Šçš„è¨˜å¸³è³‡æ–™ï¼Œä¸¦åŒæ­¥ Google è©¦ç®—è¡¨çš„è³‡æ–™è‡³æ‰‹æ©Ÿã€‚")) {
                downloadData();
            }
        }

        function uploadData() {
            fetch(apiUrl, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ action: "upload", records: records })
            })
            .then(response => {
                alert("è³‡æ–™ä¸Šå‚³æˆåŠŸï¼");
            })
            .catch(error => alert("ä¸Šå‚³å¤±æ•—: " + error));
        }

        function downloadData() {
            fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                records = data;
                localStorage.setItem("records", JSON.stringify(records));
                alert("è³‡æ–™ä¸‹è¼‰æˆåŠŸï¼");
            })
            .catch(error => alert("ä¸‹è¼‰å¤±æ•—: " + error));
        }

        function showRecords() {
            let list = document.getElementById("recordList");
            list.innerHTML = "";
            records.forEach((record, index) => {
                list.innerHTML += `<div>${record.date} - ${record.type} - ${record.account} - ${record.category} - ${record.amount} <button onclick="deleteRecord(${index})">âŒ</button></div>`;
            });
        }

        function deleteRecord(index) {
            records.splice(index, 1);
            localStorage.setItem("records", JSON.stringify(records));
            showRecords();
        }

        window.onload = function() {
            initializeForm();
        };
    </script>
</body>
</html>
